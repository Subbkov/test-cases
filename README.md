# Сервис для рассылки уведомлений об истекающих подписках

## Структура директорий версий

- **db** - содержит файл с дампом
- **core** - служебные файлы
  - **db** - директория для файлов с категорией базы данных
    - **DB.php** - общий файл для подключения файлов с базой данных
    - **DBConfig.php** - конфигурация для подключения к базе данных
    - **DBConnect.php** - функции для подключения и работы с базой
    - **DBFunctions.php** - общие функции (репозиторий) для работы с базой
  - **Core.php** - подключает все служебные файлы. Используется в файлах сервиса
  - **Config.php** - конфигурация сервиса
  - **CoreFunctions.php** - общие функции для сервиса
  - **ErrorHandler.php** - обработчик исключений и ошибок
  - **Vendor.php** - вендорные функции
- **src** - файлы сервиса
  - **cron** - файлы для крон задач

## Общая информация

`Для всех вариантов в кронах использовать flock.`

В рамках решения задачи по отправке email об истекающих сроках подписки пользователей проверка на валидность email - не выполняется.
- Во-первых - это зона ответственности другого сервиса (по регистрации и работы с пользователями).
- Во-вторых - это дополнительная нагрузка на текущий сервис, к тому же ещё и платная.
- В третьих - так как момент (обязательности подтверждения email для подписанного пользователя) оставлен на моё усмотрение, то это условие является обязательным и тем самым снимается обязанность с текущего сервиса на проверку электронной почты - потому что все подписанные пользователи уже подтвердили свой email и он является валидным. Если же пользователь после регистрации изменял свой email - то опять таки - ответственность за проверку почты лежит на другом сервисе.

Варианты с shell_exec, pthreads и т.д - не рассматриваются.

Так как указано ограничение (без ООП), то всё реализация выполнена в процедурном стиле, но с ООП подходом по архитектуре, потому что писать всю реализацию в одном файле мне не позволяет совесть )))).


## Варианты реализации

### Вариант 1

Самый простой и быстрый. С проблемами, но имеет право на жизнь.
Отправляем только пользователям где у которых подписка заканчивается в диапазонах от 1 до 2 дня или от 3 до 4 дней. По условию, что email валидный valid = 1. Крон таска запускается 1 раз в день.

Минусы:
если “упадёт”, зависнет или ещё что-то - то уже не отправятся нужные письма; фактически по времени не успеет отправить нужным пользователям письма (5 млн - 15% = 750 тыс пользователей, 750 тыс / 30 дней = 25 тыс (на 1 день), за 2 дня = 50 тыс -  если функция send_email будет выполняться 1 секунду - то есть вероятность что отправка пройдёт успешно).
Для MVP и не большого количества пользователей такая реализация подойдёт.

### Вариант 2
Такой же, как и 1 вариант. Только с тем условием, что выполняет отправку не крон, а email отправляется в очередь и уже в самой очереди скрипт выполняет отправку. Есть большая вероятность что все письма будут отправлены. Вместо отправки в реальную очередь - используется заглушка.


### Вариант 3
Похожий вариант как и 1, но с тем условием что крон таска изменена и будет выполняться 1 раз в минуту. И за 1 раз обрабатывать по 100 записей. Так же при этом записывается timestamp последней отправки уведомления в новое поле. И при выборке записей это поле тоже учитывается. Как и в варианте №1 - большая вероятность что не все пользователи будут уведомлены, но минимальная вероятность что “упадёт” и вообще ничего не отправит.


### Вариант 4
Имитация очередей на основе таблицы. Крон задача 1 выполняется 1 раз в минуту. Собирать будет по 1000 записей. Id записей пользователей будут класться в новую таблицу. Крон задача 2 - будет получать записи из новой таблицы по 100 и отправлять их.

### Вариант 5
Улучшенная имитация очередей. Как и в варианте 4, только в новую таблицу добавляется ещё поле группа. И для каждой группы добавляется свой крон. Это самый быстрый и простой вариант решения задачи. Минус - большое количество кронов. Плюс - все письма будут отправлены в срок.
